<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova OS - T.I. Extremo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .item-row { background: #f8f9fa; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .total-section { background: #e3f2fd; padding: 15px; border-radius: 5px; font-size: 1.2rem; }
        .btn-remove { cursor: pointer; color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fas fa-laptop-code"></i> T.I. Extremo</a>
            <a href="/os/listar" class="btn btn-light btn-sm"><i class="fas fa-list"></i> Ver OSs</a>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-plus-circle"></i> Nova Ordem de Serviço</h4>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/os/nova" id="formOS">
                            <!-- DADOS DO CLIENTE -->
                            <h5 class="border-bottom pb-2 mb-3">Dados do Cliente</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Cliente *</label>
                                    <input type="text" name="cliente" class="form-control" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Telefone *</label>
                                    <input type="text" name="telefone" class="form-control" placeholder="(00) 00000-0000" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">CEP</label>
                                    <input type="text" id="cep" class="form-control" placeholder="00000-000" maxlength="9">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Endereço</label>
                                    <input type="text" id="endereco" name="endereco" class="form-control">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control">
                                </div>
                            </div>

                            <!-- DADOS DO EQUIPAMENTO -->
                            <h5 class="border-bottom pb-2 mb-3 mt-4">Equipamento</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tipo de Equipamento *</label>
                                    <select name="equipamento" class="form-select" required>
                                        <option value="">Selecione...</option>
                                        <option>Notebook</option>
                                        <option>Desktop</option>
                                        <option>All-in-One</option>
                                        <option>Impressora</option>
                                        <option>Monitor</option>
                                        <option>Servidor</option>
                                        <option>Outro</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Marca/Modelo</label>
                                    <input type="text" name="modelo" class="form-control" placeholder="Ex: Dell Inspiron 15">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Descrição do Problema *</label>
                                <textarea name="problema" class="form-control" rows="3" required placeholder="Descreva o problema reportado pelo cliente..."></textarea>
                            </div>

                            <!-- ORÇAMENTO INLINE -->
                            <h5 class="border-bottom pb-2 mb-3 mt-4">
                                Orçamento (Opcional)
                                <small class="text-muted">- Pode ser adicionado depois</small>
                            </h5>
                            
                            <div id="itensContainer"></div>
                            
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <input type="text" id="newDesc" class="form-control" placeholder="Descrição do serviço/peça">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" id="newQtd" class="form-control" placeholder="Qtd" value="1" min="1">
                                </div>
                                <div class="col-md-3">
                                    <input type="number" id="newValor" class="form-control" placeholder="Valor unitário" step="0.01" min="0">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-success w-100" onclick="adicionarItem()">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>

                            <div class="total-section text-end">
                                <strong>Valor Total do Orçamento:</strong>
                                <span class="text-primary ms-2" style="font-size: 1.5rem">R$ <span id="totalValor">0,00</span></span>
                            </div>

                            <input type="hidden" name="orcamento_json" id="orcamento_json">
                            
                            <!-- BOTÕES -->
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save"></i> Criar Ordem de Serviço
                                </button>
                                <a href="/" class="btn btn-outline-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let itens = [];

        // Busca CEP
        document.getElementById('cep').addEventListener('blur', function() {
            let cep = this.value.replace(/\D/g, '');
            if (cep.length === 8) {
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(r => r.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('endereco').value = 
                                `${data.logradouro}, ${data.bairro}, ${data.localidade}/${data.uf}`;
                        }
                    })
                    .catch(err => console.error('Erro ao buscar CEP:', err));
            }
        });

        function adicionarItem() {
            const desc = document.getElementById('newDesc').value;
            const qtd = parseFloat(document.getElementById('newQtd').value) || 1;
            const valor = parseFloat(document.getElementById('newValor').value) || 0;

            if (!desc) {
                alert('Preencha a descrição');
                return;
            }

            const item = { desc, qtd, valor, subtotal: qtd * valor };
            itens.push(item);
            renderizarItens();

            // Limpa campos
            document.getElementById('newDesc').value = '';
            document.getElementById('newQtd').value = '1';
            document.getElementById('newValor').value = '';
            document.getElementById('newDesc').focus();
        }

        function removerItem(index) {
            itens.splice(index, 1);
            renderizarItens();
        }

        function renderizarItens() {
            const container = document.getElementById('itensContainer');
            container.innerHTML = '';

            let total = 0;
            itens.forEach((item, index) => {
                total += item.subtotal;
                container.innerHTML += `
                    <div class="item-row">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <strong>${item.desc}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                ${item.qtd}x
                            </div>
                            <div class="col-md-2 text-end">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                            <div class="col-md-2 text-end">
                                <strong>R$ ${item.subtotal.toFixed(2)}</strong>
                            </div>
                            <div class="col-md-1 text-end">
                                <i class="fas fa-trash btn-remove" onclick="removerItem(${index})"></i>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('totalValor').textContent = total.toFixed(2).replace('.', ',');
            document.getElementById('orcamento_json').value = JSON.stringify(itens);
        }

        // Formatação de telefone
        document.querySelector('input[name="telefone"]').addEventListener('input', function(e) {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length <= 11) {
                val = val.replace(/^(\d{2})(\d)/g, '($1) $2');
                val = val.replace(/(\d)(\d{4})$/, '$1-$2');
                e.target.value = val;
            }
        });
    </script>
</body>
</html>
